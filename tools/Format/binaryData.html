<html>
<head>
	<meta charset="UTF-8"/>
	<title>JavaScript - Binary Files Derp</title>
</head>
<body>
<div id="out"></div>
<script>
/*
sources:
http://www.html5rocks.com/en/tutorials/file/xhr2/#disqus_thread
http://stackoverflow.com/questions/15341912/how-to-go-from-blob-to-arraybuffer
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray
*/
var rnd = Math.floor(Math.random() * 3);
console.log(rnd);
var place = document.getElementById("out");
var fUrl = 'myBin0' + rnd + '.bin';
if (rnd == 2) fUrl = "AllChars.bin"; //thx josh for the file!
console.log(fUrl);
var xhr = new XMLHttpRequest();
xhr.open('GET', fUrl, true);
xhr.responseType = 'blob';

xhr.onload = function(e) {
  if (this.status == 200) {
    var blob = this.response;
	var header = blob.slice(0);
	var arrayBuffer;
	var fileReader = new FileReader();
	var isValid = false;
	fileReader.onload = function() {
		arrayBuffer = this.result;
		var data = new Uint8Array(arrayBuffer);
		var idString = "$BINCUSTOM-E0151";
		var fHeadString = "";
		var hexD = [];
		var asciiD = "";
		for (var i=0; i < 16; i++) {
			fHeadString += String.fromCharCode(data[i]);
		}		
		isValid = (fHeadString == idString);
		if (isValid) {
		console.log("valid file!");
		place.innerHTML = "valid file!" + " , HEADER: " + fHeadString;
		} else {
		console.log("invalid file!");
		place.innerHTML = "invalid file!" + " , HEADER: " + fHeadString;
		}
		place.innerHTML += "<br/>file: " + fUrl;
		for (var i=0; i < data.length; i++) {
			if(data[i] < 32) {asciiD += "."} else {
				asciiD += String.fromCharCode(data[i]);
			}
		}
		for (var i=0; i < data.length; i++) {
			if (data[i] > 15) {hexD.push(data[i].toString(16))} else {
			hexD.push("0" + data[i].toString(16));
			}
		}
		place.innerHTML += "<br/><strong>contents:</strong>";
		place.innerHTML += "<br/><br/><strong>as ascii:</strong>";
		place.innerHTML += "<br/>" + asciiD;
		place.innerHTML += "<br/><br/><strong>as hex:</strong>";
		place.innerHTML += "<br/>" + hexD.join(" ");
		if (isValid) {
		//tech demo need not read all the header data, since program only recognizes myBin00, hard-coded the file info
			place.innerHTML += "<br/><br/><strong>file type:</strong> ETX BINARY ASSET FILE - SERIES 0151 (id : $BINCUSTOM-E0151)";
			place.innerHTML += "<br/><strong>content type: </strong> 24-bit RGB COLOR PALETTE (Short contentType = 0x0000)";
		//end header data, also...shame on me for forgetting a length byte/short!
			place.innerHTML += "<br/><strong>length:</strong> FORMAT-RESTRICTED (8 colors)";
			place.innerHTML += "<br/><strong>data:</strong>";
		//parse color data starting at offset 0x12 (18)
			var i2 = 0x12;
			var palD = "";
			for (var i=0; i < 8; i++) {
				palD += "<BR/>#";
				var r = data[i2];
				var g = data[i2 + 1];
				var b = data[i2 + 2];
				if (r > 15) {palD += r.toString(16)} else {
				palD += "0" + r.toString(16);
				}
				if (g > 15) {palD += g.toString(16)} else {
				palD += "0" + g.toString(16);
				}
				if (b > 15) {palD += b.toString(16)} else {
				palD += "0" + b.toString(16);
				}
				palD += "&nbsp;&nbsp;&nbsp;&nbsp;(R,G,B: [ " + r + " , " + g + " , " + b + " ])";
				i2 += 3;
			}
			place.innerHTML += palD;
		}
	};
	fileReader.readAsArrayBuffer(header);
  }
};

xhr.send();
</script>
</body>

</html>